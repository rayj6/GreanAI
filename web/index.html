<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Green AI - Knowledge Crystallization</title>
    <link rel="stylesheet" href="./assets/styles/index.css" />
  </head>
  <body>
    <div class="dashboard">
      <div class="glow-effect"></div>

      <header>
        <div class="logo">GREEN AI <span class="version">v1.0</span></div>
        <div class="engine-status">
          CRYSTAL ENGINE: <span id="engine-state">READY</span>
        </div>
      </header>

      <section class="stats-container">
        <div class="stat-card">
          <label>T·ªîNG S·ªê ƒê·ªàNH (VERTICES)</label>
          <div id="v-count" class="number">0</div>
          <div class="sub-label">ƒê·∫°i di·ªán cho c√°c t·ª´ v·ª±ng ƒë·ªôc b·∫£n</div>
        </div>
        <div class="stat-card">
          <label>LI√äN K·∫æT TINH TH·ªÇ (EDGES)</label>
          <div id="e-count" class="number">0</div>
          <div class="sub-label">M·ªëi quan h·ªá h√¨nh h·ªçc gi·ªØa c√°c t·ª´</div>
        </div>
      </section>

      <section class="upload-section">
        <label for="file-upload" class="custom-file-upload">
          üìÅ CH·ªåN D·ªÆ LI·ªÜU (CSV, TXT, PDF)
        </label>
        <input
          id="file-upload"
          type="file"
          multiple
          onchange="handleFileSelect(this)"
          style="display: none"
        />
        <div id="file-list" class="file-list">Ch∆∞a c√≥ t·ªáp n√†o ƒë∆∞·ª£c ch·ªçn</div>
      </section>

      <section class="progress-area">
        <div class="info">
          <span id="current-file">S·∫µn s√†ng n·∫°p d·ªØ li·ªáu...</span>
          <span id="percentage">0%</span>
        </div>
        <div class="bar-bg">
          <div id="progress-fill" class="bar-fill"></div>
        </div>
      </section>

      <div class="console-wrapper">
        <div id="console-log" class="console">
          <div>> System initialized. Please upload data to begin.</div>
        </div>
      </div>

      <button id="start-btn" onclick="triggerTraining()" disabled>
        KH·ªûI CH·∫†Y K·∫æT TINH
      </button>
    </div>

    <script type="text/javascript" src="/eel.js"></script>
    <script>
      let selectedFiles = [];

      function handleFileSelect(input) {
        const list = document.getElementById("file-list");
        const btn = document.getElementById("start-btn");
        list.innerHTML = "";
        selectedFiles = Array.from(input.files);

        if (selectedFiles.length > 0) {
          selectedFiles.forEach((f) => {
            const item = document.createElement("div");
            item.className = "file-item";
            item.innerText = `üìÑ ${f.name} (${(f.size / 1024).toFixed(1)} KB)`;
            list.appendChild(item);
          });
          btn.disabled = false;
          btn.innerText = "B·∫ÆT ƒê·∫¶U HU·∫§N LUY·ªÜN";
        }
      }

      // Thay ƒë·ªïi h√†m triggerTraining ƒë·ªÉ h·ªó tr·ª£ c·∫£ vƒÉn b·∫£n v√† h√¨nh ·∫£nh
      // T√¨m ƒëo·∫°n n√†y trong index.html v√† thay th·∫ø:
      async function triggerTraining() {
        const btn = document.getElementById("start-btn");
        btn.disabled = true;
        document.getElementById("engine-state").innerText = "UPLOADING";

        for (const file of selectedFiles) {
          update_ui(`ƒêang n·∫°p: ${file.name}...`, 0, 0, 0);

          // Chuy·ªÉn t·∫•t c·∫£ v·ªÅ Base64 (bao g·ªìm c·∫£ .txt, .jfif, .jpg)
          const base64Data = await readFileAsDataURL(file);

          // G·ª≠i v·ªÅ Python qua m·ªôt h√†m x·ª≠ l√Ω chung
          const success = await eel.handle_universal_upload(
            file.name,
            base64Data
          )();

          if (!success) {
            update_ui(`L·ªói t·∫£i t·ªáp: ${file.name}`, 0, 0, 0);
            btn.disabled = false;
            return;
          }
        }

        update_ui("ƒê√£ n·∫°p xong to√†n b·ªô. B·∫Øt ƒë·∫ßu k·∫øt tinh...", 0, 0, 0);
        document.getElementById("engine-state").innerText = "PROCESSING";
        eel.request_training()();
      }

      function readFileAsDataURL(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = () => reject("L·ªói ƒë·ªçc t·ªáp");
          reader.readAsDataURL(file);
        });
      }

      eel.expose(update_ui);
      function update_ui(msg, percent, v_count, e_count) {
        document.getElementById("current-file").innerText = msg;
        document.getElementById("percentage").innerText = percent + "%";
        document.getElementById("progress-fill").style.width = percent + "%";
        document.getElementById("v-count").innerText = v_count.toLocaleString();
        document.getElementById("e-count").innerText = e_count.toLocaleString();

        const consoleBox = document.getElementById("console-log");
        const newLog = document.createElement("div");
        newLog.innerText = `> ${msg}`;
        consoleBox.appendChild(newLog);
        consoleBox.scrollTop = consoleBox.scrollHeight;

        if (percent === 100) {
          document.getElementById("engine-state").innerText = "COMPLETED";
          document.getElementById("start-btn").innerText = "K·∫æT TINH HO√ÄN T·∫§T";
          document.getElementById("start-btn").style.borderColor = "#00ff88";
        }
      }
    </script>
  </body>
</html>
